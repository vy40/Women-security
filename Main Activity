MainActivity.java

package com.yourappname; 
import android.Manifest; 
import android.app.Activity; 
import android.app.AlertDialog; 
import android.content.Context; 
import android.content.Intent; 
import android.content.pm.PackageManager; 
import android.location.Location; 
import android.location.LocationListener; 
import android.location.LocationManager; 
import android.media.MediaPlayer; 
import android.os.Build; 
import android.os.Bundle; 
import android.os.Handler; 
import android.telephony.SmsManager; 
import android.widget.Button; 
import android.widget.LinearLayout; 
import android.widget.TextView; 
import android.widget.Toast; 
import androidx.annotation.NonNull; 
import androidx.core.app.ActivityCompat; 
import androidx.core.content.ContextCompat; 
import java.util.ArrayList; 
import java.util.List; 
public class MainActivity extends Activity { 
private static final int PERMISSION_REQUEST_CODE = 1; 
private MediaPlayer mediaPlayer; 
private Handler sirenHandler; 
private Runnable stopSirenRunnable; 
16 
17 
 
    private List<String> guardianNumbers; 
 
    @Override 
    protected void onCreate(Bundle savedInstanceState) { 
        super.onCreate(savedInstanceState); 
      LinearLayout layout=new LinearLayout(this); 
      layout.setOrientation(LinearLayout.VERTICAL); 
        TextView textView=new TextView(this); 
        textView.setText("Guardian number activity loaded"); 
        textView.setTextSize(22f); 
        layout.addView(textView); 
 
        setContentView(R.layout.activity_main); 
         
        // Keep only the correct layout here 
 
        Button sosButton = findViewById(R.id.sosButton); 
        Button manageGuardiansButton = findViewById(R.id.manageGuardiansButton); 
 
 
        // Request necessary permissions 
        requestPermissions(); 
 
        // Load guardian numbers 
        guardianNumbers = GuardianNumberActivity.getSavedGuardianNumbers(this); 
 
        // Handle SOS triggered from ShakeService 
        if (getIntent().getBooleanExtra("trigger_sos", false)) { 
            triggerSOS(); 
        } 
 
        // Start ShakeService (foreground) 
        startShakeDetectionService(); 
        Intent voiceService = new Intent(this, VoiceTriggerService.class); 
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) { 
            startForegroundService(voiceService); 
        } else { 
            startService(voiceService); 
        } 
 
        // Start VoiceTriggerService (foreground) 
        startVoiceTriggerService(); 
 
 
        // Set click listeners 
        sosButton.setOnClickListener(v -> triggerSOS()); 
 
        manageGuardiansButton.setOnClickListener(v -> { 
18 
 
            Intent intent = new Intent(MainActivity.this, GuardianNumberActivity.class); 
            startActivity(intent); 
        }); 
    } 
 
    private void startShakeDetectionService() { 
        Intent shakeIntent = new Intent(this, ShakeService.class); 
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) { 
            ContextCompat.startForegroundService(this, shakeIntent); 
        } else { 
            startService(shakeIntent); 
        } 
    } 
 
    private void startVoiceTriggerService() { 
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) 
                != PackageManager.PERMISSION_GRANTED) { 
            ActivityCompat.requestPermissions(this, 
                    new String[]{Manifest.permission.RECORD_AUDIO}, 1001); 
            return; 
        } 
 
        Intent voiceIntent = new Intent(this, VoiceTriggerService.class); 
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) { 
            ContextCompat.startForegroundService(this, voiceIntent); 
        } else { 
            startService(voiceIntent); 
        } 
    } 
 
    private void requestPermissions() { 
        String[] permissions = { 
                Manifest.permission.SEND_SMS, 
                Manifest.permission.ACCESS_FINE_LOCATION, 
                Manifest.permission.ACCESS_COARSE_LOCATION, 
                Manifest.permission.RECORD_AUDIO 
        }; 
 
        List<String> listPermissionsNeeded = new ArrayList<>(); 
        for (String permission : permissions) { 
            if (ContextCompat.checkSelfPermission(this, permission) != 
PackageManager.PERMISSION_GRANTED) { 
                listPermissionsNeeded.add(permission); 
            } 
        } 
 
        if (!listPermissionsNeeded.isEmpty()) { 
            ActivityCompat.requestPermissions(this, 
listPermissionsNeeded.toArray(new String[0]), PERMISSION_REQUEST_CODE); 
} 
} 
private void triggerSOS() { 
getLocationAndSendSMS(); 
playSiren(); 
} 
private void getLocationAndSendSMS() { 
LocationManager locationManager = (LocationManager) 
getSystemService(Context.LOCATION_SERVICE); 
if (ActivityCompat.checkSelfPermission(this, 
Manifest.permission.ACCESS_FINE_LOCATION) != 
PackageManager.PERMISSION_GRANTED && 
ActivityCompat.checkSelfPermission(this, 
Manifest.permission.ACCESS_COARSE_LOCATION) != 
PackageManager.PERMISSION_GRANTED) { 
Toast.makeText(this, "Location permission not granted", Toast.LENGTH_SHORT).show(); 
return; 
} 
Location location = 
locationManager.getLastKnownLocation(LocationManager.GPS_PROVIDER); 
if (location != null) { 
double latitude = location.getLatitude(); 
double longitude = location.getLongitude(); 
String message = "SOS! I need help. My location: https://maps.google.com/?q=" + latitude 
+ "," + longitude; 
sendSMSToAll(message); 
} else { 
locationManager.requestSingleUpdate(LocationManager.GPS_PROVIDER, new 
LocationListener() { 
@Override 
public void onLocationChanged(@NonNull Location location) { 
double latitude = location.getLatitude(); 
double longitude = location.getLongitude(); 
String message = "SOS! I need help. My location: https://maps.google.com/?q=" + 
latitude + "," + longitude; 
sendSMSToAll(message); 
} 
}, null); 
} 
} 
private void sendSMSToAll(String message) { 
19 
20 
 
        SmsManager smsManager = SmsManager.getDefault(); 
        for (String number : guardianNumbers) { 
            smsManager.sendTextMessage(number, null, message, null, null); 
        } 
 
        // Send to emergency services 
        smsManager.sendTextMessage("100", null, message, null, null); 
        smsManager.sendTextMessage("1091", null, message, null, null); 
 
        Toast.makeText(this, "SOS sent to guardians and emergency numbers", 
Toast.LENGTH_SHORT).show(); 
    } 
 
    private void playSiren() { 
        if (mediaPlayer == null) { 
            mediaPlayer = MediaPlayer.create(this, R.raw.siren); 
        } 
        mediaPlayer.start(); 
 
        if (sirenHandler == null) sirenHandler = new Handler(); 
 
        stopSirenRunnable = this::stopSiren; 
        sirenHandler.postDelayed(stopSirenRunnable, 30000); // 1 minute 
 
        new AlertDialog.Builder(this) 
                .setTitle("Siren Playing") 
                .setMessage("Click OK to stop siren manually") 
                .setPositiveButton("OK", (dialog, which) -> stopSiren()) 
                .show(); 
    } 
 
    private void stopSiren() { 
        if (mediaPlayer != null && mediaPlayer.isPlaying()) { 
            mediaPlayer.stop(); 
            mediaPlayer.release(); 
            mediaPlayer = null; 
        } 
        if (sirenHandler != null && stopSirenRunnable != null) { 
            sirenHandler.removeCallbacks(stopSirenRunnable); 
        } 
    } 
 
    @Override 
    protected void onDestroy() { 
        super.onDestroy(); 
        stopSiren(); 
    } 
} 
